<!-- markdown-toc start - Don't edit this section. Run M-x markdown-toc-refresh-toc -->
**Table of Contents**

- [Frequently Asked Questions](#frequently-asked-questions)
    - [Question: Webhook return status](#question-webhook-return-status)
        - [Answer](#answer)
    - [Question: 500s and 40x responses from webhooks](#question-500s-and-40x-responses-from-webhooks)
        - [Answer](#answer-1)
    - [Question: Missed webhook for specific booking](#question-missed-webhook-for-specific-booking)
        - [Answer](#answer-2)
    - [Question: Missed bookings](#question-missed-bookings)
        - [Answer](#answer-3)
    - [Question: Duplicate webhooks](#question-duplicate-webhooks)
        - [Answer](#answer-4)
    - [Question: Webhook security](#question-webhook-security)
        - [Answer](#answer-5)
            - [Choose a hard-to-guess path](#choose-a-hard-to-guess-path)
            - [Call the External API to verify booking data](#call-the-external-api-to-verify-booking-data)
            - [Using IP address-based ACLs or allowlists to validate the source of webhooks](#using-ip-address-based-acls-or-allowlists-to-validate-the-source-of-webhooks)
    - [Question: Integrating FareHarbor webhooks with third-party APIs](#question-integrating-fareharbor-webhooks-with-third-party-apis)
        - [Answer](#answer-9)
- [FH Webhook Best Practices](#fh-webhookapi-integration-best-practices)
    - [Consider using Zapier, or a similar service.](#consider-using-zapier-or-a-similar-service)
    - [The data model](#the-data-model)
        - [The Booking UUID](#the-booking-uuid)
        - [The Customer PK](#the-customer-pk)
    - [Retrieving All Existing Bookings](#retrieving-all-existing-bookings)

<!-- markdown-toc end -->

# Frequently Asked Questions

## Question: Webhook return status

I am implementing a webhook receiver on my server. What HTTP status
should it return?

### Answer

Your webhook receiver should always return a 200 status, to
acknowledge that the payload was received and understood. If it does
not return a 200 status, then FareHarbor may resend the webhook some
number of times, and if there is still no 200, FareHarbor will
interpret this to mean that your webhook receiver is misconfigured or
malfunctioning in some way. If this happens too often, FareHarbor
might deactivate your webhook. See
[/webhooks/webhooks.md#failing-webhooks](/webhooks/webhooks.md#failing-webhooks)

This is standard practice for webhooks. This is not REST.

## Question: 500s and 40x responses from webhooks

I have FareHarbor webhooks configured. I am seeing things in my
FareHarbor dashboard that indicate that the webhooks are failing with
error status (500 or 400-something). The message says:

    Error: request unsuccessful: 500 Server Error: Internal Server Error for url: https://my.webhook.url/
    
(or something like that).

What should I do?

### Answer

First, it is important to understand that these HTTP status codes are
generated by the RECEIVING server (i.e., your server, or whatever
server is named in the "Webhook URL" configuration on your
dashboard). These status codes are being returned TO the FareHarbor
server, which is recording them and showing them to you on the booking
page.

A 500 response indicates that FareHarbor sent a webhook, but the
receiving server experienced an unexpected fatal error--informally, it
"crashed". To resolve this, contact the person who is responsible for
your server, and ask them to look through the server logs around the
time that webhook was sent. This should provide some clues about the
problem.

A 40x response indicates that the receiving server did not like the
data for some reason. Maybe the authentication was improper, or some
fields were missing that it was expecting, or the webhook URL was
incorrect on the FareHarbor dashboard.

If the server returns a 405 response ("Method Not Allowed"), it means
that it was not prepared to handle a POST request. FareHarbor always
uses POST for webhooks. Please check your server configuration and
code and ensure that it is preapred to receive POSTs (and not just
GETs, for instance).

In either case (500 or a 40x), it is up to folks on your side to
resolve the problem. It may require a reconfiguration or modification
of your server software. Also, ensure that your server's SSL
certificate has not expired, and that is valid for the URL in your
webhook URL.

It is unlikely that the problem lies with FareHarbor. As a general
policy, FareHarbor does not make changes to the API and webhooks that
would break existing partner implementations. 

In order to debug problems with webhooks, you may want to cause the
webhook to be resent. See below for how to do that.

## Question: Missed webhook for specific booking

I missed a webhook for a specific booking. Maybe the webhook was sent,
but it received a 400 or 500 response. Or maybe it seems like the
webhook was never sent.  What can I do?

### Answer

The easiest way to resend a webhook for a specific booking is to
change something insignificant on the booking in question. Changing
the booking note is often a good choice. The webhook should be resent
shortly after any change to the booking.

If the webhook received a 500 before and if it receives a 500 again,
then your server software likely needs to be modified or
reconfigured. Please talk to your technical staff.

If the webhook receives a 40x, then check that the webhook URL is
correct, and confirm that certificates, security keys, etc. are in
place. 

## Question: Missed bookings

FareHarbor failed to send me webhooks for some bookings, rebookings,
and/or cancellations, but I don't know which ones. What should I do?

### Answer

FareHarbor tries very hard to send webhooks for new or changed
bookings. If FareHarbor fails on the first attempt, it will retry
repeatedly over some window of time.  If the server RECEIVING the
webhooks (your server) is down for a long time for some reason, there
is a chance that the webhooks won't be delivered.

In this case, the missing bookings can be retrieved using the
Availability Bookings endpoint, which allows you to retieve a list of
all bookings for a particular Availability. See
[/external-api/endpoints/endpoints.md#availability-bookings](/external-api/endpoints/endpoints.md#availability-bookings). If
you need more details than are provided by this endpoint, then you can
call the Retrieve Booking Endpoint to retrieve the full details for
each booking.

## Question: Duplicate webhooks

I receive each webhook TWICE, or more.

### Answer

Is it possible that you have multiple api keys configured to send
webhooks?

Beyond that:

A wide variety of events on the FareHarbor side trigger webhooks. Some
examples include changes to contact details, check-ins, text message
reminders sent, and so on. Many of these may not be relevant to your
particular integration. Each webhook contains complete data about the
booking.

You may receive multiple identical or nearly ideantical webhooks for
the same booking. This may happen occasionally or regularly. This is
normal. Your software must be prepared to receive identical webhooks
without malfunctioning. Keep reading to learn how to know how to
handle this situation and stay in sync with the bookings that exist in
the FareHarbor system.

## Question: Webhook security

How can I guarantee that the webhook we receive is from FareHarbor,
and not from someone else who somehow guessed the URL?

### Answer

#### Choose a hard-to-guess path

You are free to use whatever path you like in the webhook address you
provide to FareHarbor. For instance, if you use:

    https://mycompany.com/EE5746FDB4054852/fareharbor-webhook/
    
then it will be very hard to guess.

Or if you prefer, you can use something like
    
    https://mycompany.com/fareharbor-webhook/?key=EE5746FDB4054852
    
and check that you receive the expected query parameter.

#### Call the External API to verify booking data

*NOTE: External API access is granted on a on a case by case basis. To request access please contact your Account Manager or [FareHarbor Support](https://fareharbor.com/help/).*


Another security strategy: 

Whenever you receive a webhook, call the Retrieve Booking Endpoint of
the External API to retrieve the booking data:
[/external-api/endpoints/endpoints.md#retrieve-booking-endpoint](/external-api/endpoints/endpoints.md#retrieve-booking-endpoint).

Then use the retrieved data rather than the webhook payload data. 

This eliminates the potential negative impact of any "forged"
webhook. So even if someone does ascertain your webhook URL, they will
not be able to compromise your data integrity.
    
#### Using IP address-based ACLs or allowlists to validate the source of webhooks

Because FareHarbor uses distributed cloud computing, our servers' IP
addresses may change at any moment without notice. Therefore **we do
not recommend that our partners use ACLs or allowlists for security**.


## Question: Integrating FareHarbor webhooks with third-party APIs

We use a CRM that has a public API. Can FareHarbor integrate with that
CRM? Or with other third-party public APIs? Is there some way that I
can plug FareHarbor webhooks into other people's APIs?

### Answer

The easiest way to plug FareHarbor webhooks into other people's APIs
is using Zapier, or a similar service. Zapier, for instance, was
created for exactly this purpose, and allows FareHarbor to connect to
5000+ other services: https://zapier.com/apps/fareharbor/integrations

If the service you need (your CRM or whatever) is not on this list,
that means that they do not work with Zapier. Consider contacting them
and asking them to integrate with Zapier. See below for more about
Zapier.

# FH Webhook Best Practices

This section describes some best practices for integrating with FH
using webhooks and APIs.

## Consider using Zapier, or a similar service.

Before writing software to integrate with FareHarbor webhooks, look
into using Zapier or something similar. In many cases, doing an
integration this way will be quicker, easier, more reliable, and less
expensive than doing it yourself with your own servers and custom
software.

In order to integrate with the FareHarbor webhooks and/or API
directly, without using Zapier or the like, you will need time from
experienced software engineers. If you do not have them on staff, you
may need to contract them and manage them. This is not always easy.

## The data model

### The Booking UUID

The most important field in the booking schema is the "uuid" field. IF
YOU RECEIVE TWO WEBHOOKS WITH THE SAME UUID, THEY ARE TALKING ABOUT
THE SAME BOOKING. This is the most important thing to understand about
bookings.

You will likely receive multiple webhooks for the same booking. For
instance, you will receive one when it's created, and you may receive
another if the contact information is updated, or if a customer
checkin occurs.

For any given uuid, the most recent webhook received will contain the
most up-to-date data.

You can always retrieve the most recent details for a booking using
the Retrive Bookings endpoint,
[/external-api/endpoints/endpoints.md#bookings](/external-api/endpoints/endpoints.md#bookings):

    GET /companies/<shortname>/bookings/<Booking.uuid>/

### The Customer PK

Another important field is the "customers" field. This field contains
a list of customers. Each customer will have its own "pk". The PK is a
globally-unique identifier for the customer. 

The details of a booking may change, but as long as it is not
rebooked, the customer PK will not change, and can be used as an ID
within your system, directly or indirectly.

If you receive a webhook from FareHarbor for a booking that is already
recorded in your system, this new webhook may contain updated
information. Using the PK, you can check each customer's data to see
if any piece of that customer's data has changed--the contents of a
custom field, for instance.

When a rebooking occurs, customer PKs are reassigned. For most
practical purposes, you can treat a rebooking event the same as
cancellation of the old booking and creation of the new booking. Data
associated with the old booking are no longer relevant.

## Retrieving All Existing Bookings

Using the External API, it is possible to retrieve all existing bookings.

In pseudocode, it looks like this:

    retrieve a list of companies via the [Companies endpoint](/endpoints.md#companies)
    for each company,
      retrieve a list of items via the [Items endpoint](/endpoints.md#items)
      for each item,
        retrieve lists of availabilities via the [Availabilities endpoint](/endpoints.md#availabilities)
        for each availability,
          retrieve a list of bookings via the [Availability Bookings endpoint](/endpoints.md#availability-bookings)

There is sample python code to retrieve all bookings [here](/external-api/examples/retrieve_bookings.py).
